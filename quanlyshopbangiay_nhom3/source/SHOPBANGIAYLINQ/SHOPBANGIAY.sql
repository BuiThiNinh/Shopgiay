CREATE TABLE LOAIGIAY
(
	MALOAI NVARCHAR(50) NOT NULL,
	TENLOAI NVARCHAR(50)
	CONSTRAINT PK_LOAIGIAY PRIMARY KEY(MALOAI)
)

CREATE TABLE NHACC
(
	MANCC NVARCHAR(50) PRIMARY KEY,
	TENNCC NVARCHAR(50),
	SDTNHACC NVARCHAR(50) ,
	EMAIL NVARCHAR(50),
	DIACHINCC NVARCHAR(50),
	HOPTAC BIT 
)


CREATE TABLE SANPHAM
(
	MASP NVARCHAR(50) NOT NULL,
	TENSP NVARCHAR(50),
	MAU NVARCHAR(50),
	CHATLIEU NVARCHAR(50),
	GIA FLOAT,
	TINHTRANGSP NVARCHAR(50),
	MALOAI NVARCHAR(50),
	MANCC NVARCHAR(50)
	CONSTRAINT PK_sp PRIMARY KEY(MASP)
)
ALTER TABLE SANPHAM
ADD FOREIGN KEY(MALOAI) REFERENCES LOAIGIAY(MALOAI)
ALTER TABLE SANPHAM
ADD FOREIGN KEY(MANCC) REFERENCES NHACC(MANCC)

CREATE TABLE KHO
(
	MASP NVARCHAR(50) NOT NULL,
	SOLUONG INT	,
	TRANGTHAI NVARCHAR(50),
	CONSTRAINT PK_KHO PRIMARY KEY(MASP)
)

ALTER TABLE KHO
ADD  FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP)

CREATE TABLE SIZEGIAY
(
	MASP NVARCHAR(50) NOT NULL,
	SIZE INT NOT NULL,
	SOLUONG INT
	CONSTRAINT PK_SIZE PRIMARY KEY(MASP,SIZE)
)

ALTER TABLE SIZEGIAY
ADD FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP)

CREATE TABLE NHANVIEN
(
	MANV NVARCHAR(50) NOT NULL PRIMARY KEY,
	TENNV NVARCHAR(50),	
	GIOITINH NVARCHAR(5),
	SOCMND NVARCHAR(50),
	DIENTHOAINV NVARCHAR(50),
	DIACHI NVARCHAR(50),
	TINHTRANG NVARCHAR(50),
	NGAYVAOLAM DATE,
	MANQL NVARCHAR(50),
	THUONG FLOAT,
	TRU FLOAT,
	THUCLANH FLOAT
) 
ALTER TABLE NHANVIEN
ADD  FOREIGN KEY(MANQL) REFERENCES NHANVIEN(MANV)


CREATE TABLE KHUYENMAI
(
	MAKM NVARCHAR(50) NOT NULL PRIMARY KEY,
	TENKM NVARCHAR(50),
	MUCGIAM FLOAT,
	APDUNG BIT
)

CREATE TABLE CT_KHUYENMAI
(
	MAKM NVARCHAR(50) NOT NULL,
	MASP NVARCHAR(50) NOT NULL,
	NBD DATE,
	NKT DATE
	PRIMARY KEY (MAKM, MASP, NBD)
)
ALTER TABLE CT_KHUYENMAI
ADD FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP)
ALTER TABLE CT_KHUYENMAI
ADD FOREIGN KEY(MAKM) REFERENCES KHUYENMAI(MAKM)

CREATE TABLE KHACHHANG
(
	MAKH NVARCHAR(50) PRIMARY KEY,
	TENKH NVARCHAR(50),
	SDTKHACHHANG INT,
	DIACHIKH NVARCHAR(50),
	MAIL NVARCHAR(50)
)

CREATE TABLE HOADONBAN
(
	MAHD NVARCHAR(50) NOT NULL PRIMARY KEY,
	NGAYLAP DATE,
	MANV NVARCHAR(50),
	TONGTIEN FLOAT,
	MAKHTT NVARCHAR(50),
	KHVANGLAI NVARCHAR(50),
	CHIECKHAU FLOAT
) 

ALTER TABLE HOADONBAN
ADD FOREIGN KEY(MAKHTT) REFERENCES KHACHHANG(MAKH)
ALTER TABLE HOADONBAN
ADD FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
ALTER TABLE HOADONBAN
ADD FOREIGN KEY(MAKHTT) REFERENCES KHACHHANG(MAKH)

CREATE TABLE PHIEUBAOHANH
(
	MABH NVARCHAR(50) PRIMARY KEY,
	MASP NVARCHAR(50),
	NGAYHETHANDOITRA DATE,
)

ALTER TABLE PHIEUBAOHANH
ADD FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP)

CREATE TABLE CHITIETHOADONBAN
(
	MACTHDB NVARCHAR(50) PRIMARY KEY,
	MAHD NVARCHAR(50) ,
	MASP NVARCHAR(50) ,
	MABH NVARCHAR(50),
	MAKM NVARCHAR(50),
	SOLUONGBAN INT,
	DONGIABAN FLOAT,
	SIZEGIAY INT
)
ALTER TABLE CHITIETHOADONBAN
ADD FOREIGN KEY(MAKM) REFERENCES KHUYENMAI(MAKM)

ALTER TABLE CHITIETHOADONBAN
ADD FOREIGN KEY(MABH) REFERENCES PHIEUBAOHANH(MABH)

ALTER TABLE CHITIETHOADONBAN
ADD FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP)

ALTER TABLE CHITIETHOADONBAN
ADD FOREIGN KEY(MAHD) REFERENCES HOADONBAN(MAHD)

CREATE TABLE QUANLYND
(
	TENDN NVARCHAR(50) NOT NULL PRIMARY KEY,
	MK NVARCHAR(50) NOT NULL,
	HOATDONG BIT,
)

ALTER TABLE QUANLYND
ADD FOREIGN KEY(TENDN) REFERENCES NHANVIEN(MANV)

CREATE TABLE QLNHOMND
(
	MANHOM NVARCHAR(50) NOT NULL PRIMARY KEY,
	TENNHOMND NVARCHAR(50) ,
	GHICHU NVARCHAR(50),
)

CREATE TABLE QLNDNHOMND
(	
	TENDN NVARCHAR(50) NOT NULL ,
	MANHOM NVARCHAR(50) NOT NULL ,
	GHICHU NVARCHAR(50),
	PRIMARY KEY(TENDN, MANHOM)
)
ALTER TABLE QLNDNHOMND
ADD FOREIGN KEY(TENDN) REFERENCES QUANLYND(TENDN)
ALTER TABLE QLNDNHOMND
ADD FOREIGN KEY(MANHOM) REFERENCES QLNHOMND(MANHOM)


CREATE TABLE DMMANHINH
(
	MAMANHINH NVARCHAR(20) NOT NULL PRIMARY KEY,
	TENMANHINHCHUCNANG NVARCHAR(50),
)

CREATE TABLE QLPHANQUYEN
(
	MANHOM NVARCHAR(50) NOT NULL,
	MAMANHINH NVARCHAR(20) NOT NULL,
	COQUYEN bit NOT NULL,
	PRIMARY KEY (MANHOM, MAMANHINH)
)


ALTER TABLE QLPHANQUYEN
ADD FOREIGN KEY(MANHOM) REFERENCES QLNHOMND(MANHOM)
ALTER TABLE QLPHANQUYEN
ADD FOREIGN KEY(MAMANHINH) REFERENCES DMMANHINH(MAMANHINH)

CREATE TABLE PHIEUDATHANGNCC
(
	SODONHANG NVARCHAR(50) PRIMARY KEY,
	MANCC NVARCHAR(50),
	MANV NVARCHAR(50),
	NGAYLAP DATETIME,
	TONGSOLUONGNHAP INT,
	TINHTRANGHANG NVARCHAR(50),
)

ALTER TABLE PHIEUDATHANGNCC
ADD  FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
ALTER TABLE PHIEUDATHANGNCC
ADD  FOREIGN KEY(MANCC) REFERENCES NHACC(MANCC)

CREATE TABLE CTPHIEUDATHANGNCC
(
	SODONHANG NVARCHAR(50),
	MASP NVARCHAR(50),
	COSIZE INT,
	SOLUONG INT,
	PRIMARY KEY(SODONHANG,MASP,COSIZE)
)
ALTER TABLE CTPHIEUDATHANGNCC
ADD  FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP)
ALTER TABLE CTPHIEUDATHANGNCC
ADD  FOREIGN KEY(SODONHANG) REFERENCES PHIEUDATHANGNCC(SODONHANG)

CREATE TABLE LICHSUGIA
(
	MASP NVARCHAR(50) NOT NULL,
	NGAYAPDUNG DATE NOT NULL,
	NGAYKETTHUC DATE,
	MUCGIA FLOAT,
	PRIMARY KEY(MASP, NGAYAPDUNG)
)

ALTER TABLE LICHSUGIA
ADD FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP)

CREATE TABLE DMTK
(
	MADMTK NVARCHAR(50) NOT NULL PRIMARY KEY,
	LOAITHONGKE NVARCHAR (50),
)

CREATE TABLE THONGKE_SC
(
	MATKSC NVARCHAR(50) NOT NULL PRIMARY KEY,
	MANV NVARCHAR(50) NOT NULL,
	MADMTK NVARCHAR(50) NOT NULL,
	NGAYLAPTK DATETIME,
	TONGSOSC INT,
	TONGTHU_CHI MONEY,
)
ALTER TABLE THONGKE_SC
ADD FOREIGN KEY(MADMTK) REFERENCES DMTK(MADMTK)
ALTER TABLE THONGKE_SC
ADD FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
---------------

CREATE TABLE CTTKSC
(
	MATKSC NVARCHAR(50) NOT NULL, 
	MABB NVARCHAR(50) NOT NULL,
	THU_CHI MONEY,
	PRIMARY KEY (MATKSC, MABB)
)
ALTER TABLE CTTKSC
ADD FOREIGN KEY(MATKSC) REFERENCES THONGKE_SC(MATKSC)
ALTER TABLE CTTKSC
ADD FOREIGN KEY(MABB) REFERENCES BIENBANSUCO(MABB)


CREATE TABLE THONGKE_DS
(
	MATKDS NVARCHAR(50) NOT NULL PRIMARY KEY,
	MANV NVARCHAR(50) NOT NULL,
	MADMTK NVARCHAR(50) NOT NULL,
	NGAYLAPTK DATETIME,
	TONGSODS INT,
	TONGTIENDS MONEY,
)
ALTER TABLE THONGKE_DS
ADD FOREIGN KEY(MADMTK) REFERENCES DMTK(MADMTK)
ALTER TABLE THONGKE_DS
ADD FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)


CREATE TABLE CTTKDS
(
	MATKDS NVARCHAR(50) NOT NULL, 
	MASP NVARCHAR(50) NOT NULL,
	MALOAI NVARCHAR(50) NOT NULL,
	TIEN MONEY,
	PRIMARY KEY (MATKDS, MASP)
)
ALTER TABLE CTTKDS
ADD FOREIGN KEY(MATKDS) REFERENCES THONGKE_DS(MATKDS)
ALTER TABLE CTTKDS
ADD FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP)
ALTER TABLE CTTKDS
ADD FOREIGN KEY(MALOAI) REFERENCES LOAIGIAY(MALOAI)


CREATE TABLE THONGKE_CUOINAM
(
	MATKCN NVARCHAR(50) NOT NULL PRIMARY KEY,
	MANV NVARCHAR(50) NOT NULL,
	MADMTK NVARCHAR(50) NOT NULL,
	NGAYLAPTK DATETIME,
	TONGTIENDS_CN MONEY,
)
ALTER TABLE THONGKE_CUOINAM
ADD FOREIGN KEY(MADMTK) REFERENCES DMTK(MADMTK)
ALTER TABLE THONGKE_CUOINAM
ADD FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)

CREATE FUNCTION SINHMA()
RETURNS NVARCHAR(30)
AS
	BEGIN
	DECLARE @MA NVARCHAR(100)
	SET @MA=CONVERT(NVARCHAR(10),MONTH(GETDATE()))+CONVERT(NVARCHAR(10),DAY(GETDATE()))+REPLACE(((CONVERT(NVARCHAR(10),(GETDATE()),108))),':','')
	RETURN @MA
END


-------------------------------------------

CREATE TABLE PHIEUNHAP
(
	MAPN NVARCHAR(50) NOT NULL PRIMARY KEY,
	MANV NVARCHAR(50),
	SODONHANG NVARCHAR(50),
	NGAYNHAP DATE,
	TONGTIENNHAP FLOAT,
)


ALTER TABLE PHIEUNHAP
ADD FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
ALTER TABLE PHIEUNHAP
ADD FOREIGN KEY(SODONHANG) REFERENCES PHIEUDATHANGNCC(SODONHANG)



CREATE TABLE CHITIETPHIEUNHAP
(
	MACTPN NVARCHAR(50) NOT NULL,
	MAPN NVARCHAR(50),
	MASP NVARCHAR(50),
	SOLUONGSP INT,
	GIATIEN FLOAT
	PRIMARY KEY(MACTPN)
)
ALTER TABLE CHITIETPHIEUNHAP
ADD FOREIGN KEY(MAPN) REFERENCES PHIEUNHAP(MAPN)
ALTER TABLE CHITIETPHIEUNHAP
ADD FOREIGN KEY(MASP) REFERENCES SANPHAM(MASP)


CREATE TABLE BIENBANSUCO
(
	MABB NVARCHAR(50) NOT NULL PRIMARY KEY,
	MANV NVARCHAR(50) NOT NULL,
	GHICHU NVARCHAR(500) ,
	THU_CHI MONEY,
	NGAYLAPBB DATE,
	SDT nvarchar(50),
	TENNGUOIBILAPBB nvarchar(50),
	nhanvien bit
)

ALTER TABLE BIENBANSUCO
ADD FOREIGN KEY(MANV) REFERENCES NHANVIEN(MANV)
Set dateformat dmy
INSERT INTO NHANVIEN
VALUES ('NV01',N'Nguyễn Quang Vinh',N'Nam','212142899','0378298647',N'140 Lê trọng tấn',N'Đang làm việc','2/2/2017',NULL,'1000000','300000','6700000')
Set dateformat dmy
INSERT INTO NHANVIEN
VALUES ('NV02',N'Nguyễn Quang Vinh',N'Nam','212125499','0378298647',N'140 Lê trọng tấn',N'Đang làm việc','2/2/2017','NV01','1000000','300000','6700000')
Set dateformat dmy
INSERT INTO NHANVIEN
VALUES ('NV03',N'Nguyễn Thị Tuyết Hoa',N'Nữ','212832144','0965894875',N'64 Nguyễn Đỗ cung',N'Đang làm việc','2/2/2017','NV02','1000000','300000','6700000')
Set dateformat dmy
INSERT INTO NHANVIEN
VALUES ('NV04',N'Hông Nhung',N'Nữ','324567894','034895754',N'11 Dương Đức Hiền',N'Đang làm việc','2/2/2017','NV01','1000000','300000','6700000')
Set dateformat dmy
INSERT INTO NHANVIEN
VALUES ('NV05',N'Nguyễn Thị Thu Sương',N'Nữ','142154684','031589742',N'63 Phạm Ngọc Thảo',N'Đang làm việc','2/12/2019','NV03','1000000','100000','6900000')
Set dateformat dmy
INSERT INTO NHANVIEN
VALUES ('NV06',N'Thanh Thu',N'Nu','121458794','031589742',N'63 Lê TRọng Tấn',N'Đang làm việc','30/12/2019','NV05','2000000','10000','7900000')
Set dateformat dmy
INSERT INTO NHANVIEN
VALUES ('NV07',N'Thanh Lợi',N'Nam','121458526','031589742',N'63 Tân Quý',N'Đang làm việc','30/12/2019','NV05','2000000','10000','7900000')
Set dateformat dmy
INSERT INTO NHANVIEN
VALUES ('NV08',N'Xuân Phương',N'Nam','154785479','0125497820',N'63 Trường Chinh',N'Đang làm việc','3/12/2019','NV06','2000000','10000','7900000')
--------------------------------------------------------------------------------------------------

INSERT INTO QUANLYND
VALUES ('NV01','123456789','true'),
('NV02','123456789','false'),
('NV03','123456789','false'),
('NV04','123456789','false'),
('NV05','123456789','false'),
('NV06','123456789','false'),
('NV07','123456789','false'),
('NV08','123456789','false')

INSERT INTO LOAIGIAY
values ('L01',N'Giày thể thao'),
	('L02',N'giày cao gót'),
	('L03',N'Giày boot')

insert into NHACC
values (N'NCC1 ', N'Công ty CP quốc Tế Vip', '37932702', N'info@evashoes.com.vn', N'26 Nguyễn Phong Sắc, Cầu Giấy, Hà Nội'),
		(N'NCC2', N'Công ty Giày Thái Dương', '37520198', N'Giaytd@gmail.com    ', N'3 Tân Thới nhất, Hóc Môn, tp Hồ CHí Minh'),
		(N'NCC3  ', N'Công Ty Bitit', '3813786', N'bitit@bitit.com.vn  ', N'1 Phạm Văn Thuận, Biên Hòa, Đồng Nai')
----------------------------------------
insert into SANPHAM
values ('SP1',N'Adidas NDM',N'Xanh',N'Vải','1000000',N'Đang kinh doanh','L01','NCC1'),
		('SP2',N'sneakers',N'Xanh',N'Vải','1000000',N'Đang kinh doanh','L01','NCC2')
insert into SANPHAM
values('SP3',N'Vans',N'Xanh',N'Vải','2000000',N'Hàng sắp về','L01','NCC2')

insert into KHO
values ('SP1','50',N'Còn hàng'),
		('SP2','40',N'Còn hàng')

INSERT INTO SIZEGIAY
VALUES ('SP1',37,20),
		('SP1',38,10),
		('SP2',39,30)

insert into DMMANHINH
values ('MH1',N'Bán Hàng'),
		('MH2',N'Nhập phiếu hàng'),
		('MH3',N'Sản Phẩm'),
		('MH4',N'Sự cố'),
		('MH5',N'Người dùng'),
		('MH6',N'Quyền'),
		('MH7',N'Thống kê'),
		('MH8',N'KHO')
insert into DMMANHINH
values('MH9',N'GIÁ'),
		('MH10',N'CTKM'),
		('MH11',N'Bảo hành'),
		('MH12',N'khách hàng'),
		('MH13',N'NCC'),
		('MH6',N'KHO')



insert into QLNHOMND
values ('N01',N'Bán hàng',NULL),
		('N02',N'Nhập hàng',NULL),
		('N03',N'Sản phẩm',NULL),
		('N04',N'quản lý Sự cố',NULL),
		('N05',N'quản lý người dùng',NULL),
		('N06',N'Quản lý thống kê',NULL)

insert into QLNDNHOMND
values ('NV01','N01',NULL)
insert into QLNDNHOMND
values('NV02','N03',NULL),
		('NV03','N02',NULL),
		('NV04','N04',NULL),
		('NV05','N01',NULL),
		('NV06','N05',NULL),
		('NV07','N06',NULL)

insert into QLPHANQUYEN
values ('N01','MH1','true'),
		('N02','MH2','true'),
		('N03','MH3','true'),
		('N04','MH4','true'),
		('N05','MH5','true'),
		('N06','MH7','true'),
		('N02','MH8','true'),
		('N01','MH10','true'),
		('N01','MH9','true')

insert into QLPHANQUYEN
values ('N02','MH13','true'),
('N03','MH10','true'),
('N04','MH5','true')

insert into QLPHANQUYEN
values ('N01','MH6','true'),
('N03','MH6','true'),
('N06','MH6','true'),
('N04','MH6','true'),
('N02','MH6','true')

insert into QLPHANQUYEN
values ('N01','MH3','true'),
('N02','MH3','true'),
('N01','MH12','true'),
('N05','MH12','true'),
('N03','MH9','true')

set dateformat dmy
insert into PHIEUDATHANGNCC
values ('DH1','NCC1','NV01','26/9/2019','0',N'chưa Giao')
set dateformat dmy
insert into PHIEUDATHANGNCC
values ('DH2','NCC2','NV03','26/9/2019','0',N'chưa Giao')
--------------------------------------------------------------------
------------------

insert into CTPHIEUDATHANGNCC
values ('DH1','SP1','5','20')
insert into CTPHIEUDATHANGNCC
values ('DH1','SP2','5','20')
insert into CTPHIEUDATHANGNCC
values ('DH2','SP2','10','30')

create trigger gslsizegiay
on CHITIETHOADONBAN
FOR INSERT, UPDATE, DELETE
AS
	IF UPDATE(MASP)
	BEGIN
	IF(SELECT SOLUONGBAN FROM inserted)<(SELECT SOLUONGSIZE FROM inserted, SIZEGIAY WHERE inserted.MASP=SIZEGIAY.MASP AND inserted.SIZEGIAY=SIZEGIAY.SIZE )
	BEGIN
		UPDATE SIZEGIAY
		SET SOLUONGSIZE=SOLUONGSIZE+(SELECT SOLUONGBAN FROM deleted)
		WHERE SIZEGIAY.MASP=(SELECT MASP FROM deleted) AND SIZEGIAY.SIZE=(SELECT SIZEGIAY FROM deleted)

		UPDATE SIZEGIAY
		SET SOLUONGSIZE=SOLUONGSIZE-(SELECT SOLUONGBAN FROM inserted)
		WHERE SIZEGIAY.MASP=(SELECT MASP FROM inserted) AND SIZEGIAY.SIZE=(SELECT SIZEGIAY FROM inserted)
	END
	ELSE
	BEGIN
		ROLLBACK TRAN
	END

	END
	ELSE
	BEGIN
	IF(SELECT SOLUONGBAN FROM inserted)<(SELECT SOLUONGSIZE FROM inserted, SIZEGIAY WHERE inserted.MASP=SIZEGIAY.MASP AND inserted.SIZEGIAY=SIZEGIAY.SIZE )
	BEGIN
		UPDATE SIZEGIAY
		SET SOLUONGSIZE=SOLUONGSIZE-(SELECT SOLUONGBAN FROM inserted)
		WHERE SIZEGIAY.MASP=(SELECT MASP FROM inserted) AND SIZEGIAY.SIZE=(SELECT SIZEGIAY FROM inserted)

		UPDATE SIZEGIAY
		SET SOLUONGSIZE=SOLUONGSIZE+(SELECT SOLUONGBAN FROM deleted)
		WHERE SIZEGIAY.MASP=(SELECT MASP FROM deleted) AND SIZEGIAY.SIZE=(SELECT SIZEGIAY FROM deleted)
	END
	ELSE
	BEGIN
		ROLLBACK TRAN
	END

	END
GO

